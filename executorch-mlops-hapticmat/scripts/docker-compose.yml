version: '3.8'

services:
  minio:
    image: minio/minio:RELEASE.2024-10-13T13-34-11Z
    container_name: minio
    ports:
      - "9000:9000" # S3 API
      - "9001:9001" # Console
    environment:
      MINIO_ROOT_USER: writeyouruser
      MINIO_ROOT_PASSWORD: writeyourpassword

    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    # volumes: - ./minio_data:/data # For permanent storage of data

  mysql:
    image: mysql:8.0.31
    container_name: mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: writeyourpassword
      MYSQL_DATABASE: mlflow_db
    # CRITICAL FIX: Forces MySQL to use compatible encryption method
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pstrongpassword123"]
      interval: 10s
      timeout: 5s
      retries: 5

  mlflow:
    image: 50bc8a5aeacf # Your MLflow image ID
    container_name: mlflow_server
    ports:
      - "5001:5000"
    environment:
      MLFLOW_S3_ENDPOINT_URL: http://minio:9000
      AWS_ACCESS_KEY_ID: writeyouruser
      AWS_SECRET_ACCESS_KEY: writeyourpassword
    # Install pymysql and start the server before starting MLflow
    command: /bin/bash -c "pip install pymysql && mlflow server --host 0.0.0.0 --port 5000 --backend-store-uri mysql+pymysql://root:strongpassword123@mysql:3306/mlflow_db --default-artifact-root s3://mlflow-artifacts/"
    depends_on:
      minio:
        condition: service_healthy
      mysql:
        condition: service_healthy

  jenkins:
    image: veribilimiokulu/jenkins:ltsjdk17-ansible9.5.1
    container_name: mlops-jenkins
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
    # CRITICAL FIX: We specify the 'root' user to run apt commands
    user: root
    command: /bin/bash -c "apt update && apt install -y python3-venv && /usr/bin/tini -- /usr/local/bin/jenkins.sh"


volumes:
  jenkins_home:

